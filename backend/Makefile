.PHONY: help build up down restart logs shell-auth shell-db shell-task clean test dev prod status health db-migrate-task

# Default target
help:
	@echo "ğŸš€ Taskly Backend - Available commands:"
	@echo ""
	@echo "ğŸ“¦ Container Management:"
	@echo "  build          - Build all services"
	@echo "  up             - Start all services"
	@echo "  down           - Stop all services"
	@echo "  restart        - Restart all services"
	@echo "  clean          - Remove containers, volumes and images"
	@echo ""
	@echo "ğŸ” Monitoring:"
	@echo "  logs           - Show logs from all services"
	@echo "  logs-gateway   - Show API gateway logs"
	@echo "  logs-auth      - Show auth service logs"
	@echo "  logs-task      - Show task service logs"
	@echo "  logs-db        - Show database logs"
	@echo "  logs-orchestrator - Show orchestrator logs"
	@echo "  status         - Show container status"
	@echo "  health         - Check service health"
	@echo "  test-api       - Test API endpoints via gateway"
	@echo ""
	@echo "ğŸ› ï¸ Development:"
	@echo "  shell-auth     - Open shell in auth service container"
	@echo "  shell-task     - Open shell in task service container"
	@echo "  shell-db       - Open psql shell in auth database"
	@echo "  shell-task-db  - Open psql shell in task database"
	@echo "  dev            - Start development environment"
	@echo "  test           - Run tests"
	@echo "  test-coverage  - Run tests with coverage report"
	@echo ""
	@echo "ğŸ—„ï¸ Database:"
	@echo "  db-migrate-auth - Run auth service database migrations"
	@echo "  db-migrate-task - Run task service database migrations"
	@echo "  db-reset       - Reset database (WARNING: destroys data)"
	@echo "  db-backup      - Create database backup"
	@echo "  db-tables-auth - List all tables in auth_db"
	@echo "  db-tables-task - List all tables in task_db"
	@echo "  db-users       - Show users table"
	@echo "  db-roles       - Show roles table"
	@echo "  db-query       - Run custom SQL query"
	@echo ""

# Container Management
build:
	@echo "ğŸ—ï¸ Building all services..."
	docker-compose build

up:
	@echo "ğŸš€ Starting all services..."
	docker-compose up -d

down:
	@echo "ğŸ“¦ Stopping all services..."
	docker-compose down

restart: down up
	@echo "ğŸ”„ Services restarted!"

clean:
	@echo "ğŸ§¹ Cleaning up containers, volumes and images..."
	docker-compose down -v --remove-orphans
	docker system prune -f
	docker volume prune -f

# Monitoring
logs:
	@echo "ğŸ“‹ Showing logs from all services..."
	docker-compose logs -f

logs-gateway:
	@echo "ğŸ“‹ Showing API gateway logs..."
	docker-compose logs -f api_gateway

logs-auth:
	@echo "ğŸ“‹ Showing auth service logs..."
	docker-compose logs -f auth_service

logs-task:
	@echo "ğŸ“‹ Showing task service logs..."
	docker-compose logs -f task_service

logs-db:
	@echo "ğŸ“‹ Showing auth database logs..."
	docker-compose logs -f auth_db

logs-task-db:
	@echo "ğŸ“‹ Showing task database logs..."
	docker-compose logs -f task_db

logs-orchestrator:
	@echo "ğŸ“‹ Showing orchestrator logs..."
	docker-compose logs -f orchestrator

status:
	@echo "ğŸ“Š Container status:"
	docker-compose ps

health:
	@echo "ğŸ” Checking service health..."
	@echo "API Gateway: http://localhost:8000/health"
	@if curl -s http://localhost:8000/health > /dev/null 2>&1; then \
		echo " âœ… API Gateway: Healthy"; \
		curl -s http://localhost:8000/health | python3 -m json.tool; \
	else \
		echo " âŒ API Gateway: Unhealthy"; \
	fi
	@echo ""
	@echo "Auth Service (via Gateway): http://localhost:8000/auth/health"
	@if curl -s http://localhost:8000/auth/health > /dev/null 2>&1; then \
		echo " âœ… Auth Service (via Gateway): Healthy"; \
	else \
		echo " âŒ Auth Service (via Gateway): Unhealthy"; \
	fi
	@echo ""
	@echo "Task Service: http://localhost:8002/health" # Assuming task service has a health endpoint on 8002
	@if curl -s http://localhost:8002/health > /dev/null 2>&1; then \
		echo " âœ… Task Service: Healthy"; \
	else \
		echo " âŒ Task Service: Unhealthy"; \
	fi
	@echo ""
	@echo "Auth Database:"
	@if docker-compose exec -T auth_db pg_isready -U taskly_user -d auth_service > /dev/null 2>&1; then \
		echo " âœ… Auth Database: Healthy"; \
	else \
		echo " âŒ Auth Database: Unhealthy"; \
	fi
	@echo ""
	@echo "Task Database:"
	@if docker-compose exec -T task_db pg_isready -U taskly_user -d task_service_db > /dev/null 2>&1; then \
		echo " âœ… Task Database: Healthy"; \
	else \
		echo " âŒ Task Database: Unhealthy"; \
	fi

# Development
shell-auth:
	@echo "ğŸš Opening shell in auth service..."
	docker-compose exec auth_service /bin/bash

shell-task:
	@echo "ğŸš Opening shell in task service..."
	docker-compose exec task_service /bin/bash

shell-db:
	@echo "ğŸš Opening auth database shell..."
	docker-compose exec auth_db psql -U taskly_user -d auth_service

shell-task-db:
	@echo "ğŸš Opening task database shell..."
	docker-compose exec task_db psql -U taskly_user -d task_service_db

# Database queries
db-tables-auth:
	@echo "ğŸ“‹ Listing auth database tables..."
	docker-compose exec auth_db psql -U taskly_user -d auth_service -c "\\dt"

db-tables-task:
	@echo "ğŸ“‹ Listing task database tables..."
	docker-compose exec task_db psql -U taskly_user -d task_service_db -c "\\dt"

db-users:
	@echo "ğŸ‘¥ Users table content..."
	docker-compose exec auth_db psql -U taskly_user -d auth_service -c "SELECT id, username, tenant_id FROM users;"

db-roles:
	@echo "ğŸ”‘ Roles table content..."
	docker-compose exec auth_db psql -U taskly_user -d auth_service -c "SELECT * FROM roles;"

db-query:
	@echo "ğŸ’» Run custom query (usage: make db-query SQL='SELECT * FROM users;')"
	docker-compose exec auth_db psql -U taskly_user -d auth_service -c "$(SQL)"

dev: build
	@echo "ğŸ› ï¸ Starting development environment..."
	docker-compose up -d
	@echo "ğŸ“± Services available at:"
	@echo "  - API Gateway: http://localhost:8000"
	@echo "  - Auth Service (via Gateway): http://localhost:8000/auth/"
	@echo "  - Task Service: http://localhost:8002"
	@echo "  - Redpanda Console: http://localhost:8080"

test:
	@echo "ğŸ§ª Running tests..."
	docker-compose exec auth_service python -m pytest tests/ -v

test-coverage:
	@echo "ğŸ“Š Running tests with coverage..."
	cd auth_service && python3 -m pytest --cov=app --cov-report=term-missing --cov-report=html
	@echo "ğŸ“‹ Coverage report generated in auth_service/htmlcov/"
	@echo "ğŸŒ Open auth_service/htmlcov/index.html in your browser to view detailed coverage"

# Database Operations
db-migrate-auth:
	@echo "ğŸ—„ï¸ Running auth service database migrations..."
	docker-compose exec auth_service alembic upgrade head

db-migrate-task:
	@echo "ğŸ—„ï¸ Running task service database migrations..."
	docker-compose exec task_service alembic upgrade head

db-reset:
	@echo "âš ï¸ Resetting database (this will destroy all data)..."
	@read -p "Are you sure? Type 'yes' to continue: " confirm && [ "$$confirm" = "yes" ] || exit 1
	docker-compose down
	docker volume rm backend_postgres_data || true
	docker volume rm backend_postgres_data_task || true # Remove task service volume
	docker-compose up -d auth_db task_db
	@sleep 10
	docker-compose up -d auth_service task_service
	@echo "âœ… Database reset complete!"

db-backup:
	@echo "ğŸ’¾ Creating database backup..."
	@mkdir -p backups
	docker-compose exec auth_db pg_dump -U taskly_user -d auth_service > backups/auth_backup_$(shell date +%Y%m%d_%H%M%S).sql
	docker-compose exec task_db pg_dump -U taskly_user -d task_service_db > backups/task_backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Backups created in backups/ directory"

# Utilities
fix-auth:
	@echo "ğŸ”§ Running authentication fix..."
	./fix-auth.sh

# Quick commands
quick-restart-gateway:
	@echo "ğŸ”„ Quick restart API gateway..."
	docker-compose restart api_gateway

quick-restart-auth:
	@echo "ğŸ”„ Quick restart auth service..."
	docker-compose restart auth_service

quick-restart-task:
	@echo "ğŸ”„ Quick restart task service..."
	docker-compose restart task_service

quick-restart-db:
	@echo "ğŸ”„ Quick restart auth database..."
	docker-compose restart auth_db

quick-restart-task-db:
	@echo "ğŸ”„ Quick restart task database..."
	docker-compose restart task_db

# Install development dependencies
install-dev:
	@echo "ğŸ“¦ Installing development dependencies..."
	docker-compose exec auth_service pip install pytest black flake8 isort
	docker-compose exec task_service pip install pytest black flake8 isort # Install for task service too

# Show service URLs
urls:
	@echo "ğŸŒ Service URLs:"
	@echo "  ğŸŒ API Gateway: http://localhost:8000"
	@echo "  ğŸ“± Auth Service (via Gateway): http://localhost:8000/auth/"
	@echo "  ğŸ“ Task Service: http://localhost:8002"
	@echo "  ğŸ“Š Gateway Health: http://localhost:8000/health"
	@echo "  ğŸ“Š Auth Health (via Gateway): http://localhost:8000/auth/health"
	@echo "  ğŸ“Š Task Health: http://localhost:8002/health"

# API Testing via Gateway
test-api:
	@echo "ğŸ§ª Testing API endpoints via Gateway..."
	@echo "ğŸ” Testing Gateway Health..."
	@curl -s http://localhost:8000/health | python3 -m json.tool || echo "âŒ Gateway not responding"
	@echo ""
	@echo "ğŸ” Testing Auth Service via Gateway..."
	@curl -s http://localhost:8000/auth/health | python3 -m json.tool || echo "âŒ Auth service not responding via gateway"
	@echo ""
	@echo "ğŸ” Testing Task Service..."
	@curl -s http://localhost:8002/health | python3 -m json.tool || echo "âŒ Task service not responding"
	@echo ""
	@echo "ğŸ” Testing Auth Endpoints via Gateway..."
	@echo "ğŸ“‹ Available auth endpoints:"
	@echo "  POST /auth/auth/register - User registration"
	@echo "  POST /auth/auth/login - User login"
	@echo "  GET  /auth/auth/users - List users (authenticated)"
	@echo "  GET  /auth/health - Health check"
	@echo ""
	@echo "ğŸ” Testing Task Endpoints..."
	@echo "ğŸ“‹ Available task endpoints:"
	@echo "  POST /projects/ - Create a new project"
	@echo "  GET  /projects/ - List all projects"
	@echo "  GET  /projects/{project_id} - Get a project by ID"
	@echo "  PUT  /projects/{project_id} - Update a project by ID"
	@echo "  DELETE /projects/{project_id} - Delete a project by ID"
	@echo "  POST /tasks/ - Create a new task"
	@echo "  GET  /tasks/ - List all tasks"
	@echo "  GET  /tasks/{task_id} - Get a task by ID"
	@echo "  PUT  /tasks/{task_id} - Update a task by ID"
	@echo "  DELETE /tasks/{task_id} - Delete a task by ID"
	@echo ""
	@echo "ğŸ§ª Example registration test:"
	@echo 'curl -X POST "http://localhost:8000/auth/auth/register" \'
	@echo '  -H "Content-Type: application/json" \'
	@echo '  -d '"'"'{"username":"user@test.com","password":"pass123","tenant_id":"tenant_1"}'"'"''

# Build specific services
build-gateway:
	@echo "ğŸ—ï¸ Building API Gateway..."
	docker-compose build api_gateway

build-auth:
	@echo "ğŸ—ï¸ Building Auth Service..."
	docker-compose build auth_service

build-task:
	@echo "ğŸ—ï¸ Building Task Service..."
	docker-compose build task_service

build-orchestrator:
	@echo "ğŸ—ï¸ Building Orchestrator..."
	docker-compose build orchestrator
	@echo "  ğŸ“‹ Auth Service Docs: http://localhost:8001/docs"
	@echo "  ğŸ“ Task Service Docs: http://localhost:8002/docs"
	@echo "  ğŸ”„ Redpanda Console: http://localhost:9644"
	@echo "  ğŸ—„ï¸ Databases: auth_db:5432, task_db:5432 (internal only)"
